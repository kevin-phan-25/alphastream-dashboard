<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ALPHASTREAM v5.8 — ROSS CAMERON</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
  <style>
    body { background: #0a0e17; color: #00ff88; font-family: 'Courier New'; }
    .card { background: #1a1f2e; border: 1px solid #00ff88; }
    .scanner-item { transition: 0.2s; cursor: pointer; }
    .scanner-item:hover { background: #00ff8820; transform: scale(1.02); }
    .ross-pattern { position: absolute; border: 2px dashed #00ff88; pointer-events: none; z-index: 10; }
    .badge-hot { background: #ff4500; }
    .badge-cold { background: #00bfff; }
    .pattern-img { max-width: 100%; border-radius: 8px; }
  </style>
</head>
<body>

<div class="container-fluid p-3">
  <div class="row">
    <!-- SCANNER + CHART -->
    <div class="col-lg-8">
      <div class="card p-3 mb-3">
        <h3>SCANNER <span id="mode-badge" class="badge"></span></h3>
        <div id="scanner" class="row"></div>
      </div>

      <div class="card p-3">
        <h4>CHART: <span id="chart-symbol">—</span></h4>
        <div style="position:relative;">
          <canvas id="chart"></canvas>
          <div id="pattern-overlay"></div>
        </div>
      </div>
    </div>

    <!-- STATS + TRADES + PATTERNS -->
    <div class="col-lg-4">
      <div class="card p-3 mb-3">
        <h5>STATS</h5>
        <div id="stats" class="small"></div>
      </div>

      <div class="card p-3 mb-3">
        <h5>RECENT TRADES</h5>
        <div id="trades" class="small"></div>
      </div>

      <div class="card p-3">
        <h5>ROSS PATTERN GUIDE</h5>
        <div id="pattern-guide" class="row">
          <div class="col-6 mb-2">
            <strong>Bull Flag</strong>
            <img src="patterns/bull-flag-1.png" class="pattern-img">
          </div>
          <div class="col-6 mb-2">
            <strong>Flat Top</strong>
            <img src="patterns/flat-top-1.png" class="pattern-img">
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const ws = new WebSocket('ws://' + location.host);
let chart = null;

ws.onmessage = (e) => {
  const msg = JSON.parse(e.data);
  if (msg.type === 'INIT') {
    renderScanner(msg.scanner);
    renderTrades(msg.trades);
    renderStats(msg.stats);
  }
  if (msg.type === 'SCANNER') renderScanner(msg.data);
  if (msg.type === 'TRADE') prependTrade(msg.data);
  if (msg.type === 'STATS') renderStats(msg.data);
};

function renderScanner(candidates) {
  const el = document.getElementById('scanner');
  const isHot = candidates.some(c => c.strategy === 'GAP_GO');
  document.getElementById('mode-badge').textContent = isHot ? 'HOT' : 'COLD';
  document.getElementById('mode-badge').className = isHot ? 'badge badge-hot' : 'badge badge-cold';

  el.innerHTML = candidates.map(c => `
    <div class="scanner-item col-md-6 p-2 mb-2 rounded border" onclick="loadChart('${c.symbol}')">
      <div><strong>${c.symbol}</strong> <small>${c.strategy}</small></div>
      <div>+${c.gap?.toFixed(1)}% | RVOL ${c.rvol?.toFixed(1)} | Score: <strong>${c.score?.toFixed(0)}</strong></div>
    </div>
  `).join('');
}

function renderTrades(trades) {
  document.getElementById('trades').innerHTML = trades.map(t => `
    <div class="${t.result === 'WIN' ? 'text-success' : 'text-danger'}">
      ${t.symbol} ${t.result} @ $${t.entry} → $${t.exit || '—'} 
      <strong>${t.pnl > 0 ? '+' : ''}$${t.pnl?.toFixed(0)}</strong>
    </div>
  `).join('');
}

function renderStats(s) {
  document.getElementById('stats').innerHTML = `
    Win Rate: <strong>${s.winRate}%</strong><br>
    PnL: <strong class="${s.pnl >= 0 ? 'text-success' : 'text-danger'}">$${s.pnl}</strong><br>
    Mode: <strong>${s.mode}</strong><br>
    Updated: ${new Date(s.lastUpdate).toLocaleTimeString()}
  `;
}

async function loadChart(symbol) {
  document.getElementById('chart-symbol').textContent = symbol;
  const res = await fetch(`/chart/${symbol}`);
  const bars = await res.json();

  if (chart) chart.destroy();
  chart = new Chart(document.getElementById('chart'), {
    type: 'candlestick',
    data: { datasets: [{ label: symbol, data: bars.map(b => ({ x: b.t, o: b.o, h: b.h, l: b.l, c: b.c })) }] },
    options: { animation: false, scales: { x: { type: 'time', time: { unit: 'minute' }}}}
  });

  detectAndDrawRossPatterns(bars);
}

function detectAndDrawRossPatterns(bars) {
  const overlay = document.getElementById('pattern-overlay');
  overlay.innerHTML = '';

  const flag = detectBullFlag(bars);
  if (flag) drawPattern(overlay, flag, 'BULL FLAG', '#00ff88');

  const flat = detectFlatTop(bars);
  if (flat) drawPattern(overlay, flat, 'FLAT TOP', '#ffcc00');
}

function drawPattern(container, { left, right, top, bottom }, label, color) {
  const div = document.createElement('div');
  div.className = 'ross-pattern';
  div.style.left = `${left}%`;
  div.style.top = `${top}%`;
  div.style.width = `${right - left}%`;
  div.style.height = `${bottom - top}%`;
  div.style.borderColor = color;
  div.innerHTML = `<div style="position:absolute;top:-20px;left:0;background:${color};color:black;padding:2px 6px;font-size:10px;">${label}</div>`;
  container.appendChild(div);
}

function detectBullFlag(bars) {
  if (bars.length < 20) return null;
  const recent = bars.slice(-15);
  const pole = recent.slice(0, 3).every((b, i, arr) => i === 0 || b.c > arr[i-1].c);
  if (!pole) return null;
  const breakout = recent[recent.length-1];
  const flagHigh = Math.max(...recent.slice(3, -1).map(b => b.h));
  if (breakout.c > flagHigh * 1.01) {
    return { left: 15, right: 90, top: 10, bottom: 40 };
  }
  return null;
}

function detectFlatTop(bars) {
  if (bars.length < 12) return null;
  const highs = bars.slice(-10, -2).map(b => b.h);
  const resistance = Math.max(...highs);
  const variation = highs.reduce((s, h) => s + Math.abs(h - resistance), 0) / highs.length;
  if (variation > resistance * 0.02) return null;
  const breakout = bars[bars.length-1];
  if (breakout.c > resistance * 1.01) {
    return { left: 40, right: 85, top: 15, bottom: 35 };
  }
  return null;
}
</script>
</body>
</html>
